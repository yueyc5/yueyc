[1.1 VPN](#1 )


##<font color = red id = "1"></font>1.1 VPN
###1.1.1 VPN基本概念
VPN就是虚拟专用网，互联网本质是一个开放的网络，没有任何安全性可言，而VPN就是实现用户安全通信的一种技术。
###1.1.2 VPN关键技术
使用VPN需要登录客户端，涉及到保密需要对数据进行加密，以及需要使用一种网络协议承载另外一种协议，因此涉及到主要技术有**隧道技术 加解密技术 密钥管理技术 身份认证技术**。  
**隧道技术就是利用网络中的基础设施进行网络通信的一种技术。隧道协议将其他协议的数据重新封装在新的包头中进行传送**，从而实现数据在网络上的传送。隧道协议可以实现在数据链路层、网络层和传输层。
###1.1.3 VPN解决方案
**内联网VPN(Intranet VPN)** 企业内部各个局域网之间的保密通信。  
**外联网VPN(Extranet VPN)** 企业和客户以及供应商之间的保密通信。
**接入层VPN(Access VPN)** 流动人员利用ISP提供的VPN服务和企业通信。
##1.2 第二层隧道协议
工作在数据链路层的隧道协议，常见的有PPTP（**tunnel：隧道**），L2TP(二层隧道协议)。

###1.2.1 PPTP的工作过程
**PAC**（PPTP Access Concentrator，PAC） 接入网集中器：负责接入客户端设备。  
**PNS**(PPTP Network Server,PNS) 网络服务器：接入服务器。  
![avatar](../image/1.png)
**PAC与PNS**之间具有两条通道，一条运行在TCP层的控制连接（**建立 管理 释放PPP隧道**），一条是传输数据单元的IP隧道。  
PPP分组必须经过**GRE**封装后才能在PAC-PNS隧道传送。  
**GRE** Generic Routing Encapsulation，一种网络层协议内部封装另外一层网络层协议，对数据加密处理。 VPN外设备无法探知其内容。

**负载数据在本地和远程都是IP明文传输，只有在VPN中进行了加密和封装**。

###1.1.2 第2层隧道协议
**L2TP** （Layer 2 Tunnling Protocal，L2TP）  
**L2TP Access Server**：LAS,l2tp接入服务器
**L2TP Network Server**: LNS, L2TP网络服务器
**Network Access Server**：NAS,网络接入服务器
![典型的L2TP接入模式](../image/2.png)

**用户用过传统电话网或者综合数字接入网（PSTN/ISDN）接入到l2tp接入服务器**  
**L2TP本身无加密措施，在Ip网中，需要借助UDP（传输层）协议加密，数据的压缩也同样如此**
**L2TP隧道中的数据承载在PPP协议中。**  

**图中展示的是L2TP中数据的封装过程。**
![典型的L2TP接入模式](../image/3.png)
##1.3 IPSec
###1.3.1 Ipsec的基本功能
**IPSec（IP Security）**是网络层协议（第三层）用于增强网络的安全性。其功能主要有**数据完整性、认证、保密性、应用透明的安全性**。
**应用透明的安全性**指的是安全性指的是IPSec具有认证和加密作用的头直接放在原来的IP头和上层协议（TCP)之间，因而，对原来的数据不需要进行处理即可从IP转向IPsec。
![图中展示的是在原来的IP头和TCP之间加入认证头](../image/4.png)
  
**图中展示的是在原来的IP头和TCP之间加入认证头**。
###1.3.2 IPSec的功能分类
**认证头**：提供数据完整性和数据源认证。
**封装安全负荷**：提供数据保密性和完整性，防止重放攻击。
**密钥交换协议**：用于生成和分发在ESP和AH中使用的密钥。也可进行安全认证。

###1.4 SSL
**安全套接层（Secure Socket Layer）**：传输层安全协议，用于实现Web安全通信。
SSL的基本目标是实现两个实体之间安全可靠的通信。SSL协议分为两层，底层是SSL记录协议，运行于TCP之上。
![图中展示的是SSL协议栈](../image/5.png)

**SSL协议栈**

##1.5 BGP 
###1.5.1 BGP中基本概念
**BGP(Border Gateway Protocal 边界网关协议)**    

* 不同自治域之间交换路由的协议。    
* 采用距离-向量路由协议。（**主要路由表项**）
* 寻找能够达到目的地的比较好的路由，而非最佳路由。（**采用多种策略进行路由选择**）  
  
**Peer**：相互交互报文的Speaker之间互称对等体（Peer）。
**Speaker**：发送BGP报文的设备称为BGP发言者，并发布给其他Speaker。  
**Route ID**：BGP设备的32位置值，在open报文中携带，具有唯一性。缺省情况下，本地lookback接口的IPV4地址作为路由器号。
**BGP的基本原理**    

* 每个自治域选择至少一个路由器发言人（Speker）。  
* 每一个发言人与其他自治域中发言人建立TCP连接。
* 在TCP连接上交换BGP报文以及建立BGP会话，交流路由信息，这样就可以找到各自的路由。
![图中展示的BGP](../image/6.png)
**BGP的特点**  
* Speaker的个数和自治系统数量相当，因此路由选择比较简单。
* 支持CIDR(Classless Inter-Domain Routing 无类别域间路由)。
* 主要路由表项：目的网络前缀、下一跳路由器以及到达该目的网络需要经过的各个自治系统序列。
**BGP的报文**
* 打开报文：建立对等体联系。
* 更新报文：发送路由以及撤销路由。
* 保活路由： 用来确认打开报文和周期性地确认对等体还活着。
* 通知报文：用来发送检测到的差错。

**————————————————————————————————————————————————————————————————————**
##1.6 MPLS
###1.6.1 MPLS基本概念

**MPLS** 全称是Multi-Protocal Label Switching 多协议标签交换技术。感性认识就是：MPLS是一种通讯网络上的高性能数据传输技术。（**MPLS是高性能数据传输技术**）  
###1.6.2 MPLS解决了什么问题
####传统网络的路由决策过程
传统网络中，当一个数据包在路由器之间传输的时候，每个路由器都对这个数据包做出路由决策。**路由决策就是路由器决定数据包如何路由转发的过程**。每个路由器都要分析包头，对照路由表，通过下一跳（next hop）将数据包发出去。**以IP报文为例，路由决策时基于目的IP地址，路由器根据目的IP地址，选择路由条目，再做转发。**    
 
**路由决策**  

 * 分类，将特定的数据包归属为一个等价转发类。
 * 查找，查找等价转发类对应的next hop（下一跳）。
#### MPLS路由决策
MPLS网络中，当网络数据包进入MPLS网络的时候，对网络数据包进行解析，计算所归属的等价转发类。从而对数据包打标，当网络数据包在MPLS网络中传输时，路由决策都是基于标签，路由器不需要再解析数据包，这样就快多了。这就是MPLS是**一种高效的数据传输的技术。**
###1.6.3 MPLS的相关概念
 * **FEC（Forwarding Equivalence Class）**：等价转发类，同样的转发路径的网络数据包的集合。
 * **LSH(label Switching Hop)** IP协议报文从一个MPLS转发到另外一个MPLS设备。
 * **NHLFE(Next Hop Lable Forwarding Entry)**：LSR中的转发条目，相当于路由器中的路由表。
   * 下一跳
   * 替换标签、删除标签、增加标签。
 * **LER（Lable Edge Router）**：有的地方叫做MPLS edge node 。mpls网络的边缘设备。
 * **MPLS ingress node**：mpls网络的入口节点。该设备计算出报文归属的等价转发类（Fowarding enquivalence Class）并对数据打上标签。
 * **MPLS egress node**: mpls网络的出口节点。
 * **LSR(Lable Swithing Router)**支持mpls转发的路由器。
 * **LSP(Lable Switching Path)** 特定的FEC（forwording enquivalence Class 等价转发类）经过的LSR的集合。LSR通常也被叫做MPLS tunnel （mpls隧道）。
 
###1.6.4 MPLS的转发过程
<font color=red>**知乎提问1st**</font>  
求问为什么在MPLS网络中转发需要不断的替换标签？直接用一个标签表示一条路由路径，中途不进行替换不可以吗？  
<font color=blue> **mpls 入口节点的路由表有哪些信息，根据上文我们可以知道LSR的转发条目有下一跳信息、转发表信息。由此可知，mpls入口节点根据每个数据包的目的地址，进行等价转发类的归属划分，同一个归属的包被打上相同的标签。这样就被转发给下一个LSR,下一个路由器同样要经过归属等价转发类的划分，因此需要替换，当到达最后一个交换机就把标签撕掉** </font>  
![图中展示的一个标签交换路径](../image/9.png)  
<font color=red>**知乎提问2nd**</font>   
请问一下,数据包进入MPLS网络后,什么时候用替换,什么时候是增加标签呢.对于这一点一直没看到什么资料解释？  
  <font color=blue>** 问题1st解释了什么时候打标签，什么时候替换和删除，还需要一个打双层标签，例如IP1A——IP2B 并不能直接到达B 需要到达另外一个LSP（C1-C2-C3),因此需要打外层标签。**</font>   
![图中展示的一个标签交换路径](../image/8.png)
###1.6.5 MPLS网络的工作过程
####相关名词
* **PE**:服务提供商边界路由器。对应LER（**label edge routor**）维护与站点相关的转发表、使用BGP与其他PE路由器交换路由信息，使用MPLS转发VPN业务。
* **CE**:客户边界设备。位于客户处、提供到运营商网络的接入、CE/PE可使用动态路由协议、静态路由连接。
* **P** :提供商路由器，骨干网上路由器。对应LSR（**label sever router**）、使用已建立的LSP对VPN数据进行透明转发、不维护与VPN有关的路由信息。
![图中展示的一个标签交换路径](../image/7.png)
* 
####工作过程
* 在接受网络流量之前，PE路由器需要通过mpls网络与远端PE路由器建立LSP(标签交换路径)。
* 客户网络从CE发来的非mpls报文，发送到PE接入路由器，也就是mpls ingress edge。
* ingress PE路由器计算出IP报文属于哪一个FEC(转发等价类)，并把相应的标签加入到IP报文。
* IP协议报文沿着lsp（标签交换路径）传输，每个P路由器根据自身的NHLFE(mpls路由器转发表)。
* 在egress PE路由器，Label被从IP协议报文中删除，一个裸的IP协议报文又产生了。
* IP协议报文被送到了对端的CE路由器，最终进入了另外一个客户网络。  
![图中展示的一个MPLS的工作过程](../image/10.png)
###1.6.6 mpls节点的组成
**要注意理解所谓的逻辑概念，比如说控制平面和转发平面，mpls协议逻辑上将系统功能分成两个部分，控制面和转发面**  
**控制平面（Control Plane）**：负责标签的分配，路由选择，标签转发表的建立，标签路径的建立、拆除等工作。  
**转发平面（Fowarding Plane）** ：依据标签转发表对收到的分组进行转发。

##1.7 MPLS L3 VPN 概述
###1.7.1 基于MPLS的VPN
* 传统的VPN一般都是通过GRE、L2TP、PPTP等隧道协议来实现私有网络数据流在公网上的传送，LSP本身就是公网上隧道，因此，用mpls具有天然的优势。
* 基于MPLS的VPN就是通过LSP将私有网络的不同分支连接起来，形成一个统一的网络。基于MPLS的VPN还支持对不同VPN的互通控制。
* 基于MPLS的VPN支持不同分支间IP地址复用，并支持不同VPN间互通，与传统的路由相比，**VPN路由中需要增加分支和VPN的标识信息**，这就需要对BGP协议进行扩展，以携带VPN路由信息。



###1.7.2 MP-BGP
**MP-BGP(Mutiprotocol extentions for BGP-4)**:在PE路由器之间传播VPN的组成信息和路由。支持IPv4地址簇，也可以支持其他地址簇。这样既能确保VPN的私网路由只在VPN内发布，又实现了MPLS VPN成员间的通信。  
<font color=red>**问题3rd：MP-BGP作用到底是什么？**</font>    
**基于MPLS的VPN支持不同分支的IP地址复用，并支持不同VPN间的互通，与传统的路由相比，需要在VPN路由中增加分支和VPN的标识信息，这就需要对BGP协议进行扩展。**  
<font color=red>普通的BGP路由器设备路由是对公网IP进行路由选择和转发的，不能处理私网IP的，公网IP本身就具有唯一性，这个不多说，要想对私网路由，就要解决唯一性的问题，怎么解决这个问题呢，路由器编号+私网IP（**个人理解，不一定对**），这就需要对路由器进行扩展，以支持这种需要，要实现路径建立和转发，自然需要支持MPLS协议。</font>   
<font color=red>**问题4th：在MPLS网络中，VPN的构建，连接和管理只在PE路由器上进行？**</font>    

 | PE路由器，服务提供商边缘路由器，是服务提供商的边缘设备，于用户的CE直接相连，在MPLS网络的中对VPN的所有处理都发生在PE上。 |
| :------ |  
<font color=red>**问题5th：在运营商骨干P路由器上必须支持的协议是MPLS？**</font> 
  
| P路由器，服务提供商网络中的骨干路由器，不与CE直接相连，P设备只需要基本MPLS的转发能力 |  
| :------ |    
<font color=red>**问题6th：在PE路由器上必须支持的协议是BGP？**</font>

| CE设备，用户网络边缘设备，可以是路由器或者交换机，感知不到VPN的存在，也不需要支持MPLS |
| :------ | 

###1.7.3 MPLS路由信息发布
* 本地CE到入口PE的路由信息交换
   * CE与直接相连的PE建立联系关系后，把本站的VPN路由发布给PE.
   * CE与PE之间可以是静态路由，RIP、OSPF、ISIS或EBGP，CE发布给PE的都是标准的IPv4路由。不能感知VPN的存在。
* 入口PE到出口PE的路由信息交换
   * PE从CE学到VPN的路由信息后，为这些标准IPv4路由增加RD和VPN Target属性，形成VPN-IPv4路由，放到CE创建的VPN实例中。（**这里不明白，所谓CE创建的VPN实例的意思，个人认为是放在PE中**）入口PE通过MP-BGP把VPN-IPv4路由发布给出口PE。出口PE根据VPN-IPv4路由的Export Target属性与自己维护的Import Target ，巨顶是否将该路由加入到VPN实例的路由表。
   
* 出口PE到远端CE的路由信息交换
  * 远端CE有多种方式可以从出口PE学习VPN路由。与本地CE到入口PE的路由信息交换相同。
###1.7.4 MPLS L3VPN的报文转发
在基本的MPLS L3VPN应用中，VPN报文采用两层标签方式。 

* 第一层（外部）标签在骨干网内部进行交换，指示PE之间的LSP(label switching path)，VPN报文利用这个标签，可以到达对端PE.
* 第二层（内部）标签在从对端PE到达CE的时候使用，指示报文应该送到那个Site。或者更具体应该到达哪一个CE。（**个人理解，不一定对。这个标签指的是私网IP + VPN TARGET ,用来区分CE**）

